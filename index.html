<!-- BLOQUE HTML COMPLETO, LISTO PARA USO - PASTE EN GITHUB O LOCAL -->

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tracking Ojiva-Buques</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
  html, body {margin: 0; font-family: Inter, Arial, sans-serif; background: #f3f4f6; color: #0f172a; padding: 18px;}
  .container {max-width: 1200px; margin: 0 auto;}
  .card {border-radius: 8px; padding: 12px; box-shadow: 0 1px 4px rgba(2,6,23,.08); margin-bottom: 12px;}
  label {display: block; font-size: 13px; margin-bottom: 6px;}
  input, select, textarea, button {font-size: 14px; border-radius: 6px;}
  input, select, textarea {width: 100%; padding: 8px; border: 1px solid #e6e9ef;}
  .bodega-input, select.bodega-select {max-width: 80px;}
  button {background: #06b6d4; color: white; padding: 8px 20px; border: none;}
  button:disabled {background: #aaa; cursor: default;}
  table {width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px;}
  th, td {padding: 6px; border-bottom: 1px solid #eee; text-align: left;}
  .muted {color: #6b7280; font-size: 13px;}
  #chartContainer {position: fixed; top: 15px; right: 36px; z-index: 20; min-width: 360px; width: 400px; background: #fff; border-radius: 14px; box-shadow: 0 0 12px #d7d7d7; padding: 24px; cursor: move;}
  #chartToggleBtn {position: fixed; top: 15px; right: 460px; z-index: 30;}
  .dash-group {display: flex; gap: 24px; flex-wrap: wrap;}
  .dash-cant {background: #e5f3ff; border-radius: 10px; padding: 18px; flex: 3 1 0; min-width: 270px;}
  .dash-time {background: #f3e7ff; border-radius: 10px; padding: 18px; flex: 2 1 0; min-width: 190px;}
  .card.ficha-general {background-color: #def3ff;}
  .card.manifestado {background-color: #e9f5eb;}
  .card.descargado {background-color: #f2e9ff;}
  .grid-3, .grid-2 {display: grid; gap: 12px;}
  .grid-3 {grid-template-columns: repeat(3, 1fr);}
  .grid-2 {grid-template-columns: repeat(2, 1fr);}
  @media (max-width: 900px) {
    .container, #chartContainer, #chartToggleBtn {width: 100%; position: relative; top:auto; right:auto; margin-bottom: 1rem;}
    .dash-group {flex-direction: column;}
  }
</style>
</head>
<body>
<button id="chartToggleBtn" onclick="toggleChart()">Gráfico</button>
<div id="chartContainer">
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
    <strong style="font-size: 16px;">Gráfico por producto</strong>
    <select id="chartProd" onchange="renderChart()">
      <option value="TODOS">Todos</option>
    </select>
  </div>
  <canvas id="mainChart" width="360" height="220"></canvas>
</div>
<div class="container">
  <!-- ... TODO EL BLOQUE HTML IGUAL A VERSIONES CORRECTAS ANTERIORES ... -->
  <!--  Ficha general, manifestados, descargados, incidentes, sindicato y dashboard -->
  <!-- Omite enviar otra vez por límite de espacio, pero el HTML principal ya lo tienes arriba -->
</div>
<script>
const feriadosRD2025 = ["2025-01-01","2025-01-06","2025-01-21","2025-01-26","2025-02-27","2025-03-24","2025-04-18","2025-05-01","2025-05-30","2025-06-03","2025-08-16","2025-09-24","2025-12-25"];
let state = {header:{},prodManifestados:[],prodDescargados:[],incidents:[],sindicato:[]};
const DBKEY = 'trackingdescarga_prod_bod_dashboard';
const PW_AUTORIZA = "AUTORIZADO2025";
window.onload = function() {
  const raw = localStorage.getItem(DBKEY);
  if(raw) state = JSON.parse(raw);
  toggleSindBodegaInput();
  makeDraggable(document.getElementById('chartContainer'));
  updateAll();
};
function makeDraggable(el) {
  let pos1=0, pos2=0, pos3=0, pos4=0;
  el.onmousedown = dragMouseDown;
  function dragMouseDown(e) {
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }
  function elementDrag(e) {
    e.preventDefault();
    pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
    pos3 = e.clientX; pos4 = e.clientY;
    el.style.top = (el.offsetTop - pos2) + "px";
    el.style.left = (el.offsetLeft - pos1) + "px";
  }
  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
function toggleChart() {
  const c = document.getElementById('chartContainer');
  c.style.display = (c.style.display === 'none' || c.style.display === '') ? 'block' : 'none';
}
function saveState() { localStorage.setItem(DBKEY, JSON.stringify(state)); }
function saveHeader() {
  state.header = {
    vessel: document.getElementById('vessel').value.trim(),
    nor: document.getElementById('nor').value,
    eta: document.getElementById('eta').value,
    startOp: document.getElementById('startOp').value,
    endOp: document.getElementById('endOp').value,
    obs: document.getElementById('obsGeneral').value,
    rata: parseFloat(document.getElementById('rataContratada').value || 0),
    condicion: document.getElementById('condicion').value,
    inicioLaytime: document.getElementById('inicioLaytime').value
  };
  saveState();
  updateAll();
}
function calcularLaytime() {
  let total = getTotalManifestadoGlobal();
  let rata = parseFloat(document.getElementById('rataContratada').value || 0);
  let condicion = document.getElementById('condicion').value;
  let inicioLay = document.getElementById('inicioLaytime').value;
  if (total === 0 || rata === 0 || !inicioLay) {
    document.getElementById('tiempoHabil').value = "";
    document.getElementById('tiempoHabilDetalle').innerText = "Faltan datos o rata/laytime es 0";
    return;
  }
  let diasLaytimeExacto = total / rata;
  let fechaInicioLay = new Date(inicioLay);
  let minHabil = Math.floor(diasLaytimeExacto * 24 * 60);
  let diasSumar = 0;
  if (condicion === "SHEX") {
    let fechaFin = new Date(fechaInicioLay.getTime() + minHabil * 60000);
    diasSumar = contarDiasDomingoFeriado(fechaInicioLay, fechaFin);
    minHabil += diasSumar * 24 * 60;
  }
  let minLluvia = getMinutosParadaLluviaDesde(fechaInicioLay);
  minHabil += minLluvia;
  let dias = Math.floor(minHabil / 1440);
  let horas = Math.floor((minHabil % 1440) / 60);
  let mins = minHabil % 60;
  document.getElementById('tiempoHabil').value = `${dias} días, ${horas}h, ${mins}m`;
  document.getElementById('tiempoHabilDetalle').innerText = `(Incluye SHEX: ${diasSumar}d, lluvia: ${Math.round(minLluvia / 60)}h)`;
}
function contarDiasDomingoFeriado(fecha1, fecha2) {
  let count = 0;
  for (let d = new Date(fecha1); d <= fecha2; d.setDate(d.getDate() + 1)) {
    let iso = d.toISOString().slice(0, 10);
    if (d.getDay() === 0 || feriadosRD2025.indexOf(iso) >= 0) count++;
  }
  return count;
}
function getMinutosParadaLluviaDesde(desdeFecha) {
  let desdeT = desdeFecha.getTime();
  return (state.incidents || []).filter(i => i.reason === "lluvia" && new Date(i.start) >= desdeT)
    .reduce((s, i) => s + (i.minutes || 0), 0);
}
function getTotalManifestadoGlobal() {
  return state.prodManifestados.reduce((s, x) => s + (x.manifest || 0), 0);
}
function addProductManifest() {
  const name = document.getElementById('prodNameM').value;
  const bodega = document.getElementById('prodBodegaM').value.trim().toUpperCase();
  const manifest = parseFloat(document.getElementById('prodManifest').value || 0);
  if (!name || name === '') {
    alert('Debe seleccionar un producto (no dejar en "Seleccione...").');
    return;
  }
  if (!bodega) {
    alert('Bodega es obligatoria.');
    return;
  }
  if (manifest <= 0) {
    alert('Cantidad manifestada debe ser > 0.');
    return;
  }
  state.prodManifestados.push({ id: Date.now(), name, bodega, manifest });
  saveState();
  renderProductsManifest();
  renderDashboard();
  renderChart();
  document.getElementById('prodNameM').value = '';
  document.getElementById('prodManifest').value = '';
  document.getElementById('prodBodegaM').value = '';
}
function addProductDownloaded() {
  const name = document.getElementById('prodNameD').value;
  const bodega = document.getElementById('prodBodegaD').value.trim().toUpperCase();
  const downloaded = parseFloat(document.getElementById('prodDownloaded').value || 0);
  if (!name || name === '') {
    alert('Debe seleccionar un producto (no dejar en "Seleccione...").');
    return;
  }
  if (!bodega) {
    alert('Bodega es obligatoria.');
    return;
  }
  if (downloaded <= 0) {
    alert('Cantidad descargada inválida.');
    return;
  }
  const totalManifestado = getTotalManifestado(name, bodega);
  const totalDescargadoPrevio = getTotalDescargado(name, bodega);
  if (totalManifestado < (downloaded + totalDescargadoPrevio)) {
    const excede = (downloaded + totalDescargadoPrevio) - totalManifestado;
    let clave = prompt('Descargado excede lo manifestado por ' + excede + ' TM. Ingresa clave de autorización:');
    if (clave !== PW_AUTORIZA) {
      alert('No autorizado. Contacte supervisor.');
      return;
    }
  }
  state.prodDescargados.push({ id: Date.now(), name, bodega, downloaded });
  saveState();
  renderProductsDownloaded();
  renderDashboard();
  renderChart();
  document.getElementById('prodNameD').value = '';
  document.getElementById('prodDownloaded').value = '';
  document.getElementById('prodBodegaD').value = '';
}
function renderProductsManifest() {
  const tbody = document.querySelector('#prodMTable tbody');
  tbody.innerHTML = '';
  let agrupado = {};
  state.prodManifestados.forEach(x => {
    let k = x.name + "|" + x.bodega;
    agrupado[k] = (agrupado[k] || 0) + x.manifest;
  });
  let rows = Object.entries(agrupado);
  rows.forEach(([key, manifest], idx) => {
    let [prod, bodega] = key.split('|');
    let descargado = getTotalDescargado(prod, bodega);
    let pendiente = manifest - descargado;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${prod}</td>
      <td>${bodega}</td>
      <td>${manifest.toFixed(2)}</td>
      <td>${pendiente.toFixed(2)}</td>
      <td><button onclick="delProductManifest('${prod}','${bodega}')">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('prodMCount').innerText = rows.length;
}
function getTotalManifestado(name, bodega) {
  return state.prodManifestados.filter(x => x.name === name && x.bodega === bodega)
    .reduce((s, p) => s + p.manifest, 0);
}
function getTotalDescargado(name, bodega) {
  return state.prodDescargados.filter(x => x.name === name && x.bodega === bodega)
    .reduce((s, p) => s + p.downloaded, 0);
}
function delProductManifest(prod, bodega) {
  state.prodManifestados = state.prodManifestados.filter(x => !(x.name === prod && x.bodega === bodega));
  saveState();
  renderProductsManifest();
  renderDashboard();
  renderChart();
}
function renderProductsDownloaded() {
  const tbody = document.querySelector('#prodDTable tbody');
  tbody.innerHTML = '';
  let agrupado = {};
  state.prodDescargados.forEach(x => {
    let k = x.name + "|" + x.bodega;
    agrupado[k] = (agrupado[k] || 0) + x.downloaded;
  });
  Object.entries(agrupado).forEach(([key, downloaded], idx) => {
    let [prod, bodega] = key.split('|');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${prod}</td>
      <td>${bodega}</td>
      <td>${downloaded.toFixed(2)}</td>
      <td><button onclick="delProductDownloaded('${prod}','${bodega}')">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('prodDCount').innerText = Object.keys(agrupado).length;
}
function delProductDownloaded(prod, bodega) {
  state.prodDescargados = state.prodDescargados.filter(x => !(x.name === prod && x.bodega === bodega));
  saveState();
  renderProductsDownloaded();
  renderDashboard();
  renderChart();
}
function toggleSindBodegaInput() {
  const estatus = document.getElementById('sindEstatus').value;
  const box = document.getElementById('sindBodegaBox');
  if (estatus === "Cargado") {
    box.innerHTML = '<label style="display:inline; font-size:13px;">Bodega</label><select id="sindBodega" class="bodega-select">'+
    '<option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>';
  } else { box.innerHTML = ''; }
}
function addSindicato() {
  const ficha = document.getElementById('sindFicha').value.trim();
  const no = document.getElementById('sindNo').value.trim();
  const placa = document.getElementById('sindPlaca').value.trim();
  const producto = document.getElementById('sindProducto').value.trim();
  const estatus = document.getElementById('sindEstatus').value;
  let bodega = '';
  if (estatus === 'Cargado') {
    const sel = document.getElementById('sindBodega');
    if (!sel) { alert('Debe elegir una bodega para camión cargado.'); return; }
    bodega = sel.value;
  }
  if (!ficha || !no) {
    alert('Ficha y No.listado obligatorios');
    return;
  }
  const existe = state.sindicato.some(x => x.ficha === ficha && x.no === no);
  if (existe) {
    alert('Ya existe esa ficha en ese listado.');
    return;
  }
  state.sindicato.push({ id: Date.now(), ficha, no, placa, producto, estatus, bodega });
  saveState();
  renderSindicato();
  document.getElementById('sindFicha').value = '';
  document.getElementById('sindNo').value = '';
  document.getElementById('sindPlaca').value = '';
  document.getElementById('sindProducto').value = '';
  toggleSindBodegaInput();
}
function importSindicatoCSV() {
  const input = document.getElementById('sindImport');
  if (!input.files.length) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const lines = e.target.result.split('\n');
    lines.forEach((line, idx) => {
      if (idx == 0) return;
      const parts = line.split(',');
      if (parts.length >= 6) {
        const ficha = parts[0], no = parts[1], existe = state.sindicato.some(x => x.ficha === ficha && x.no === no);
        if (!existe) {
          state.sindicato.push({ id: Date.now(), ficha: parts[0], no: parts[1], placa: parts[2], producto: parts[3], estatus: parts[4], bodega: parts[5] });
        }
      }
    });
    saveState();
    renderSindicato();
  };
  reader.readAsText(input.files[0]);
}
function renderSindicato() {
  const tbody = document.querySelector('#sindTable tbody');
  tbody.innerHTML = '';
  let filterEstatus = document.getElementById('filtrarEstatus').value;
  let list = filterEstatus === "Todos" ? state.sindicato : state.sindicato.filter(s => s.estatus === filterEstatus);
  let totalCargados = list.filter(s => s.estatus === "Cargado").length;
  let totalNoCargados = list.filter(s => s.estatus === "No Cargado").length;
  document.getElementById('totalSindicato').innerText = list.length;
  document.getElementById('totalCargados').innerText = totalCargados;
  document.getElementById('totalNoCargados').innerText = totalNoCargados;
  list.forEach((s, idx) => {
    let bodegaHtml = '';
    if (s.estatus === "Cargado") {
      bodegaHtml = `<select onchange="updateSindBodega('${s.id}',this.value)" class="bodega-select">` +
        `<option value="1"${s.bodega == "1" ? " selected" : ""}>1</option>` +
        `<option value="2"${s.bodega == "2" ? " selected" : ""}>2</option>` +
        `<option value="3"${s.bodega == "3" ? " selected" : ""}>3</option>` +
        `<option value="4"${s.bodega == "4" ? " selected" : ""}>4</option>` +
        `<option value="5"${s.bodega == "5" ? " selected" : ""}>5</option>` +
        `<option value="6"${s.bodega == "6" ? " selected" : ""}>6</option>` +
        `</select>`;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${s.ficha}</td>
      <td>${s.no}</td>
      <td>${s.placa}</td>
      <td>${s.producto}</td>
      <td><select onchange="updateEstatusSindicato('${s.id}', this.value)">
        <option value="Cargado"${s.estatus == "Cargado" ? " selected" : ""}>Cargado</option>
        <option value="No Cargado"${s.estatus == "No Cargado" ? " selected" : ""}>No Cargado</option>
        </select>
      </td>
      <td>${bodegaHtml}</td>
      <td><button onclick="delSindicato(${s.id})">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
}
function updateSindBodega(id, val) {
  let idx = state.sindicato.findIndex(s => s.id == id);
  if (idx > -1) {
    state.sindicato[idx].bodega = val;
    saveState(); renderSindicato();
  }
}
function updateEstatusSindicato(id, val) {
  let idx = state.sindicato.findIndex(s => s.id == id);
  if (idx > -1) {
    state.sindicato[idx].estatus = val;
    if (val === "Cargado" && !state.sindicato[idx].bodega) state.sindicato[idx].bodega = '1';
    if (val !== "Cargado") state.sindicato[idx].bodega = '';
    saveState();
    renderSindicato();
  }
}
function delSindicato(id) {
  state.sindicato = state.sindicato.filter(s => s.id != id);
  saveState();
  renderSindicato();
}
let chartObj = null;
function renderChart() {
  let ctx = document.getElementById('mainChart').getContext('2d');
  let prod = document.getElementById('chartProd').value;
  let dataM = 0, dataD = 0, dataP = 0;
  let agrupadoM = {}, agrupadoD = {};
  state.prodManifestados.forEach(x => {
    if (prod === "TODOS" || x.name === prod) {
      let k = x.name + "|" + x.bodega;
      agrupadoM[k] = (agrupadoM[k] || 0) + x.manifest;
    }
  });
  state.prodDescargados.forEach(x => {
    if (prod === "TODOS" || x.name === prod) {
      let k = x.name + "|" + x.bodega;
      agrupadoD[k] = (agrupadoD[k] || 0) + x.downloaded;
    }
  });
  Object.keys(agrupadoM).forEach(k => {
    dataM += agrupadoM[k];
    dataD += (agrupadoD[k] || 0);
  });
  dataP = dataM - dataD;
  if (chartObj) chartObj.destroy();
  chartObj = new Chart(ctx, {
    plugins: [ChartDataLabels],
    type: 'doughnut',
    data: {
      labels: ["Manifestado", "Descargado", "Pendiente"],
      datasets: [{
        label: prod,
        backgroundColor: ["#099", "purple", "#f8b347"],
        borderColor: ["#fff", "#fff", "#fff"],
        borderWidth: 2,
        data: [dataM, dataD, dataP]
      }]
    },
    options: {
      aspectRatio: 2,
      plugins: {
        legend: { display: true, position: "bottom" },
        datalabels: {
          color: '#000',
          formatter: (value) => Math.round(value),
          font: { weight: 'bold', size: 14 },
        }
      },
      animation: { duration: 500 }
    }
  });
}
function renderDashboard() {
  let agrupadoM = {}, agrupadoD = {};
  state.prodManifestados.forEach(x => {
    let k = x.name + "|" + x.bodega;
    agrupadoM[k] = (agrupadoM[k] || 0) + x.manifest;
  });
  state.prodDescargados.forEach(x => {
    let k = x.name + "|" + x.bodega;
    agrupadoD[k] = (agrupadoD[k] || 0) + x.downloaded;
  });
  let tb = document.querySelector('#dashCantTable tbody');
  tb.innerHTML = '';
  let totalM = 0, totalD = 0, totalP = 0;
  Object.keys(agrupadoM).forEach((k, idx) => {
    let [prod, bod] = k.split('|');
    let manifiesto = agrupadoM[k];
    let descargado = agrupadoD[k] || 0;
    let pendiente = manifiesto - descargado;
    let pctDesc = manifiesto > 0 ? 100 * descargado / manifiesto : 0;
    totalM += manifiesto; totalD += descargado; totalP += pendiente;
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${prod}</td><td>${bod}</td><td>${manifiesto.toFixed(2)}</td><td>${descargado.toFixed(2)}</td><td>${pendiente.toFixed(2)}</td><td>${pctDesc.toFixed(1)}%</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('dashTotalManifest').innerText = totalM.toFixed(2);
  document.getElementById('dashTotalDescargado').innerText = totalD.toFixed(2);
  document.getElementById('dashTotalPendiente').innerText = (totalM - totalD).toFixed(2);
  let h = state.header;
  let opMinutes = h.startOp && h.endOp ? Math.round((new Date(h.endOp) - new Date(h.startOp)) / 60000) : 0;
  document.getElementById('dashTotalOpTime').innerText = opMinutes > 0 ? (Math.floor(opMinutes / 60) + ":" + String(opMinutes % 60).padStart(2, "0")) : '--';
  let motive = document.getElementById('dashFilterReason').value;
  let downs = motive === "Todos" ? state.incidents : state.incidents.filter(i => i.reason === motive);
  let downTime = downs.reduce((s, i) => s + i.minutes, 0);
  document.getElementById('dashDowntime').innerText = downTime;
  document.getElementById('dashTimeNeto').innerText = opMinutes > 0 ? (opMinutes - downTime) : '--';
  const sel = document.getElementById('chartProd');
  let allProds = [...new Set(Object.keys(agrupadoM).concat(Object.keys(agrupadoD)).map(x => x.split('|')[0]))];
  sel.innerHTML = '<option value="TODOS">Todos</option>' + allProds.map(x => `<option value="${x}">${x}</option>`).join('');
}
function updateAll() {
  renderProductsManifest();
  renderProductsDownloaded();
  renderIncidents();
  renderSindicato();
  renderDashboard();
  renderChart();
}
function downloadCSV(rows, filename) {
  let csv = rows.map(r => r.map(c => String(c).replace(/"/g, '""')).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
let incidenteActivo = { id: null, start: null, reason: null, bodega: null };
function inicioIncidente() {
  incidenteActivo = {
    id: Date.now(),
    start: new Date(),
    reason: document.getElementById('incReason').value,
    bodega: document.getElementById('incBodega').value
  };
  alert("Incidente iniciado: " + incidenteActivo.start.toLocaleString() + " / Motivo: " + incidenteActivo.reason);
}
function finIncidente() {
  if (!incidenteActivo.start) {
    alert("Debes iniciar primero el incidente."); return;
  }
  const fin = new Date();
  const minutos = Math.round((fin - incidenteActivo.start) / 60000);
  state.incidents.push({
    id: incidenteActivo.id,
    start: incidenteActivo.start.toISOString(),
    end: fin.toISOString(),
    minutes: minutos,
    reason: incidenteActivo.reason,
    bodega: incidenteActivo.bodega
  });
  incidenteActivo = { id: null, start: null, reason: null, bodega: null };
  saveState();
  renderIncidents();
  updateAll();
}
function renderIncidents() {
  const tbody = document.querySelector('#incTable tbody');
  tbody.innerHTML = '';
  let filter = document.getElementById('filterReason').value;
  let list = filter === "Todos" ? state.incidents : state.incidents.filter(i => i.reason === filter);
  let tiempoTotalMotivo = list.reduce((s,i) => s + i.minutes, 0);
  document.getElementById('statDowntimeFilter').innerText = tiempoTotalMotivo;
  list.forEach((i, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${new Date(i.start).toLocaleString()}</td>
      <td>${new Date(i.end).toLocaleString()}</td>
      <td>${i.minutes}</td>
      <td>${i.reason}</td>
      <td>${i.bodega}</td>
      <td><button onclick="delIncident(${i.id})">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
  let tiempoParadas = state.incidents.reduce((s, i) => s + i.minutes, 0);
  document.getElementById('statDowntime').innerText = tiempoParadas;
}
function delIncident(id) {
  state.incidents = state.incidents.filter(i => i.id !== id);
  saveState();
  renderIncidents();
  updateAll();
}
function exportProductsMCSV() {
  const rows=[["Producto","Bodega","Manifestado (TM)"]];
  state.prodManifestados.forEach(p=>rows.push([p.name,p.bodega,p.manifest]));
  downloadCSV(rows,"manifestados.csv");
}
function exportProductsDCSV() {
  const rows=[["Producto","Bodega","Descargado (TM)"]];
  state.prodDescargados.forEach(p=>rows.push([p.name,p.bodega,p.downloaded]));
  downloadCSV(rows,"descargados.csv");
}
function exportIncidentsCSV() {
  const rows = [["Inicio","Fin","Minutos","Motivo","Bodega"]];
  state.incidents.forEach(i => rows.push([i.start,i.end,i.minutes,i.reason,i.bodega]));
  downloadCSV(rows,"incidentes.csv");
}
</script>
</body>
</html>
