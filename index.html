<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tracking Operación de Descarga - Plantilla Avanzada</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {margin: 0; font-family: Inter, Arial, sans-serif; background: #f3f4f6; color: #0f172a; padding: 18px;}
    .container { max-width: 1200px; margin: 0 auto;}
    .card { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 1px 4px rgba(2,6,23,.08); margin-bottom: 12px;}
    label { display: block; font-size: 13px; color: #54627a; margin-bottom: 6px;}
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;}
    button { background: #06b6d4; color: white; padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer;}
    button:disabled { background: #aaa; cursor: default;}
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;}
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;}
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px;}
    th, td { padding: 6px; border-bottom: 1px solid #eee; text-align: left;}
    .muted { color: #6b7280; font-size: 13px;}
    .dash-group { display: flex; gap: 24px;}
    .dash-cant { background: #e6f0ff; border-radius: 10px; padding: 18px; flex: 2 1 0;}
    .dash-time { background: #ece2fe; border-radius: 10px; padding: 18px; flex: 1 1 0;}
    .manifestado { background: #e5f9ed;}
    .descargado { background: #f4ecfd;}
    #chartContainer { position:fixed; top:15px; right:36px; z-index:20; min-width:340px; width:370px; background:#fff; border-radius:14px; box-shadow:0px 0px 12px #d7d7d7; padding:24px;}
    @media (max-width:900px) {
      .grid-3, .grid-2, .dash-group { grid-template-columns: 1fr; flex-direction: column;}
      #chartContainer { position:relative; width:100%; right:0; min-width:210px;}
    }
  </style>
</head>
<body>
<div id="chartContainer">
  <div style="display:flex;align-items:center;justify-content: space-between;">
    <strong style="font-size:16px;">Gráfico por producto</strong>
    <select id="chartProd" onchange="renderChart()">
      <option value="TODOS">Todos</option>
    </select>
  </div>
  <canvas id="mainChart" height="180"></canvas>
</div>
<div class="container">
  <h1>Tracking descarga Buques a granel</h1>
  <!-- FICHA GENERAL -->
  <div class="card">
    <strong>Ficha general</strong>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Nombre del buque</label><input id="vessel" /></div>
      <div><label>PRESENTACIÓN NOR Fecha - Hora</label><input id="nor" type="datetime-local"/></div>
      <div><label>ETA Fecha - Hora</label><input id="eta" type="datetime-local"/></div>
    </div>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Inicio de operaciones</label><input id="startOp" type="datetime-local"/></div>
      <div><label>Fin de operaciones</label><input id="endOp" type="datetime-local"/></div>
      <div><label>Observaciones generales</label><input id="obsGeneral"/></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="saveHeader()">Guardar ficha</button>
      <button onclick="updateAll()">Actualizar dashboard</button>
      <div class="muted" style="margin-left:auto;">* campos obligatorios</div>
    </div>
  </div>
  <!-- PRODUCTOS MANIFESTADOS -->
  <div class="card manifestado">
    <strong>Productos manifestados</strong>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto</label><input id="prodNameM"/></div>
      <div><label>Bodega</label><input id="prodBodegaM"/></div>
    </div>
    <div class="grid-2" style="margin-top:4px;">
      <div><label>Cantidad manifestada TM</label><input id="prodManifest" type="number" step="0.01" min="0"/></div>
      <div></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="addProductManifest()">Agregar producto manifestado</button>
      <button onclick="exportProductsMCSV()" style="background:#111827;">Exportar manifestados CSV</button>
      <div class="muted" style="margin-left:auto;">Total manifestados: <span id="prodMCount">0</span></div>
    </div>
    <table id="prodMTable">
      <thead>
        <tr><th>#</th><th>Producto</th><th>Bodega</th><th>Total Manifestado</th><th>Pendiente</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- PRODUCTOS DESCARGADOS -->
  <div class="card descargado">
    <strong>Productos descargados</strong>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto</label><input id="prodNameD"/></div>
      <div><label>Bodega</label><input id="prodBodegaD"/></div>
    </div>
    <div class="grid-2" style="margin-top:4px;">
      <div><label>Cantidad descargada TM</label><input id="prodDownloaded" type="number" step="0.01" min="0"/></div>
      <div></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="addProductDownloaded()">Agregar producto descargado</button>
      <button onclick="exportProductsDCSV()" style="background:#111827;">Exportar descargados CSV</button>
      <div class="muted" style="margin-left:auto;">Total descargados: <span id="prodDCount">0</span></div>
    </div>
    <table id="prodDTable">
      <thead>
        <tr><th>#</th><th>Producto</th><th>Bodega</th><th>Total Descargado</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- REGISTRO DE PARADAS (INCIDENTES) -->
  <div class="card">
    <strong>Registro de paradas (incidentes)</strong>
    <div class="grid-2" style="margin-top:8px;max-width: 470px;">
      <div>
        <label>Motivo</label>
        <select id="incReason">
          <option value="lluvia">Lluvia</option>
          <option value="movimiento buque">Movimiento Buque</option>
          <option value="paro por mecanizado">Paro por mecanizado</option>
          <option value="falta camiones">Falta camiones</option>
          <option value="problemas buque interno">Problemas buque interno</option>
          <option value="otros">Otros</option>
        </select>
      </div>
      <div>
        <label>Bodega afectada</label>
        <select id="incBodega">
          <option value="Bodega 1">Bodega 1</option>
          <option value="Bodega 2">Bodega 2</option>
          <option value="Buque completo">Buque completo</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px; display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <button onclick="inicioIncidente()">Inicio incidente</button>
      <button onclick="finIncidente()">Fin incidente</button>
      <button onclick="exportIncidentsCSV()" style="background:#111827;">Exportar CSV</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <strong>Tiempo total de paradas: <span id="statDowntime">0</span> min</strong>
      <span>
        Filtrar motivo:
        <select id="filterReason" onchange="updateAll()">
          <option value="Todos">Todos</option>
          <option value="lluvia">Lluvia</option>
          <option value="movimiento buque">Movimiento Buque</option>
          <option value="paro por mecanizado">Paro por mecanizado</option>
          <option value="falta camiones">Falta camiones</option>
          <option value="problemas buque interno">Problemas buque interno</option>
          <option value="otros">Otros</option>
        </select>
        <strong style="margin-left:10px;">Total motivo: <span id="statDowntimeFilter">0</span> min</strong>
      </span>
    </div>
    <table id="incTable">
      <thead>
        <tr><th>#</th><th>Inicio</th><th>Fin</th><th>Minutos</th><th>Motivo</th><th>Bodega</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- LISTADO SINDICATO -->
  <div class="card">
    <strong>Listado sindicato (fichas)</strong>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Ficha</label><input id="sindFicha" /></div>
      <div><label>No. listado</label><input id="sindNo" /></div>
      <div><label>Placa</label><input id="sindPlaca" /></div>
    </div>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto a cargar</label><input id="sindProducto" /></div>
      <div style="align-self:end;">
        <label>Estatus</label>
        <select id="sindEstatus">
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
        <button onclick="addSindicato()">Agregar</button>
        <input type="file" id="sindImport" accept=".csv" onchange="importSindicatoCSV()" style="margin-top:6px;" />
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <strong>Total camiones: <span id="totalSindicato">0</span></strong>
      <span class="muted">
        Filtrar por estatus: 
        <select id="filtrarEstatus" onchange="renderSindicato()">
          <option value="Todos">Todos</option>
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
        <span style="margin-left:10px;">Cargados: <strong id="totalCargados">0</strong></span>
        <span style="margin-left:10px;">No cargados: <strong id="totalNoCargados">0</strong></span>
      </span>
    </div>
    <table id="sindTable">
      <thead>
        <tr><th>#</th><th>Ficha</th><th>No.Listado</th><th>Placa</th><th>Producto</th><th>Estatus</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- DASHBOARD Y RESUMEN -->
  <div class="card">
    <strong>Dashboard y Resumen ejecutivo</strong>
    <div class="dash-group" style="margin-top:14px;">
      <div class="dash-cant">
        <strong>Cantidades por producto y bodega</strong>
        <table class="dash-cant-table" id="dashCantTable">
          <thead>
            <tr><th>Producto</th><th>Bodega</th><th>Manifestado</th><th>Descargado</th><th>Pendiente</th><th>% Descargado</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px;">
          <strong>Total manifestado:</strong> <span id="dashTotalManifest">0</span> TM | 
          <strong>Total descargado:</strong> <span id="dashTotalDescargado">0</span> TM | 
          <strong>Total pendiente:</strong> <span id="dashTotalPendiente">0</span> TM
        </div>
      </div>
      <div class="dash-time">
        <strong>Resumen tiempos</strong>
        <div style="margin:5px 0 0 0;">
          <strong>Bruto (inicio-fin):</strong> <span id="dashTotalOpTime">--:--</span>
        </div>
        <div style="margin:6px 0 0 0;">
          <strong>Total paradas:</strong> <span id="dashDowntime">0</span> min
        </div>
        <div style="margin:6px 0 0 0;">
          <strong>Tiempo neto operativo:</strong> <span id="dashTimeNeto">0</span> min
        </div>
        <div style="margin:6px 0 0 0;">
          Filtrar paradas por motivo: 
          <select id="dashFilterReason" onchange="updateAll()">
            <option value="Todos">Todos</option>
            <option value="lluvia">Lluvia</option>
            <option value="movimiento buque">Movimiento Buque</option>
            <option value="paro por mecanizado">Paro por mecanizado</option>
            <option value="falta camiones">Falta camiones</option>
            <option value="problemas buque interno">Problemas buque interno</option>
            <option value="otros">Otros</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
let state = {header:{},prodManifestados:[],prodDescargados:[],incidents:[],sindicato:[]};
const DBKEY = 'trackingdescarga_prod_bod_dashboard';
window.onload = function() {
  const raw = localStorage.getItem(DBKEY); if(raw) state = JSON.parse(raw);
  updateAll();
};
function saveState() { localStorage.setItem(DBKEY,JSON.stringify(state)); }
function saveHeader() {
  state.header = { vessel:document.getElementById('vessel').value.trim(),
    nor:document.getElementById('nor').value,
    eta:document.getElementById('eta').value,
    startOp:document.getElementById('startOp').value,
    endOp:document.getElementById('endOp').value,
    obs:document.getElementById('obsGeneral').value
  };
  saveState(); updateAll();
}
function updateAll() { renderProductsManifest(); renderProductsDownloaded(); renderIncidents(); renderSindicato(); renderDashboard(); renderChart(); }
function addProductManifest() {
  const name=document.getElementById('prodNameM').value.trim().toUpperCase();
  const bodega=document.getElementById('prodBodegaM').value.trim().toUpperCase();
  const manifest=parseFloat(document.getElementById('prodManifest').value||0);
  if(!name || !bodega) {alert('Producto y bodega obligatorios'); return;}
  if(manifest<=0) {alert('Cantidad manifestada debe ser > 0'); return;}
  state.prodManifestados.push({id:Date.now(),name,bodega,manifest});
  saveState(); renderProductsManifest(); renderDashboard(); renderChart();
  document.getElementById('prodNameM').value=''; document.getElementById('prodManifest').value=''; document.getElementById('prodBodegaM').value='';
}
function renderProductsManifest() {
  const tbody=document.querySelector('#prodMTable tbody'); tbody.innerHTML='';
  let agrupado = {};
  state.prodManifestados.forEach(x=>{
    let k=x.name+"|"+x.bodega; if(!agrupado[k]) agrupado[k]=0; agrupado[k]+=x.manifest;
  });
  let rows=Object.entries(agrupado);
  rows.forEach(([key,manifest],idx)=>{
    let [prod,bod]=key.split('|');
    let descargado = getTotalDescargado(prod,bod);
    let pendiente = manifest-descargado;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${prod}</td><td>${bod}</td><td>${manifest.toFixed(2)}</td><td>${pendiente.toFixed(2)}</td>
    <td><button onclick="delProductManifest('${prod}','${bod}')">Eliminar</button></td>`
    tbody.appendChild(tr);
  });
  document.getElementById('prodMCount').innerText=rows.length;
}
function getTotalDescargado(prod,bod) {
  return state.prodDescargados.filter(x=>x.name===prod&&x.bodega===bod)
    .reduce((s,p)=>s+p.downloaded,0);
}
function delProductManifest(prod,bod) {
  state.prodManifestados=state.prodManifestados.filter(x=>!(x.name===prod&&x.bodega===bod));
  saveState(); renderProductsManifest(); renderDashboard(); renderChart();
}
function exportProductsMCSV() {
  const rows=[["Producto","Bodega","Manifestado (TM)"]];
  state.prodManifestados.forEach(p=>rows.push([p.name,p.bodega,p.manifest]));
  downloadCSV(rows,"manifestados.csv");
}
function addProductDownloaded() {
  const name=document.getElementById('prodNameD').value.trim().toUpperCase();
  const bodega=document.getElementById('prodBodegaD').value.trim().toUpperCase();
  const downloaded=parseFloat(document.getElementById('prodDownloaded').value||0);
  if(!name || !bodega) {alert('Producto y bodega obligatorios'); return;}
  if(downloaded<=0) {alert('Cantidad descargada inválida'); return;}
  state.prodDescargados.push({id:Date.now(),name,bodega,downloaded});
  saveState(); renderProductsDownloaded(); renderDashboard(); renderChart();
  document.getElementById('prodNameD').value=''; document.getElementById('prodDownloaded').value=''; document.getElementById('prodBodegaD').value='';
}
function renderProductsDownloaded() {
  const tbody=document.querySelector('#prodDTable tbody'); tbody.innerHTML='';
  let agrupado={};
  state.prodDescargados.forEach(x=>{
    let k=x.name+"|"+x.bodega; if(!agrupado[k])agrupado[k]=0; agrupado[k]+=x.downloaded;
  });
  Object.entries(agrupado).forEach(([key,downloaded],idx)=>{
    let [prod,bod]=key.split('|');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${prod}</td><td>${bod}</td><td>${downloaded.toFixed(2)}</td>
    <td><button onclick="delProductDownloaded('${prod}','${bod}')">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('prodDCount').innerText=Object.keys(agrupado).length;
}
function delProductDownloaded(prod,bod) {
  state.prodDescargados=state.prodDescargados.filter(x=>!(x.name===prod&&x.bodega===bod));
  saveState(); renderProductsDownloaded(); renderDashboard(); renderChart();
}
function exportProductsDCSV() {
  const rows=[["Producto","Bodega","Descargado (TM)"]];
  state.prodDescargados.forEach(p=>rows.push([p.name,p.bodega,p.downloaded]));
  downloadCSV(rows,"descargados.csv");
}
let incidenteActivo = {id:null,start:null,reason:null,bodega:null};
function inicioIncidente() {
  incidenteActivo = {
    id: Date.now(),
    start: new Date(),
    reason: document.getElementById('incReason').value,
    bodega: document.getElementById('incBodega').value
  };
  alert("Incidente iniciado: " + incidenteActivo.start.toLocaleString() + " / Motivo: " + incidenteActivo.reason);
}
function finIncidente() {
  if(!incidenteActivo.start) {
    alert("Debes iniciar primero el incidente.");
    return;
  }
  const fin = new Date();
  const minutos = Math.round((fin - incidenteActivo.start) / 60000);
  state.incidents.push({
    id: incidenteActivo.id,
    start: incidenteActivo.start.toISOString(),
    end: fin.toISOString(),
    minutes: minutos,
    reason: incidenteActivo.reason,
    bodega: incidenteActivo.bodega
  });
  incidenteActivo = {id: null, start: null, reason: null, bodega: null};
  saveState();
  renderIncidents();
  updateAll();
}
function renderIncidents() {
  const tbody = document.querySelector('#incTable tbody');
  tbody.innerHTML = '';
  let filter = document.getElementById('filterReason').value;
  let list = filter === "Todos" ? state.incidents : state.incidents.filter(i => i.reason === filter);
  let tiempoTotalMotivo = list.reduce((s,i) => s + i.minutes, 0);
  document.getElementById('statDowntimeFilter').innerText = tiempoTotalMotivo;
  list.forEach((i, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${new Date(i.start).toLocaleString()}</td>
      <td>${new Date(i.end).toLocaleString()}</td>
      <td>${i.minutes}</td>
      <td>${i.reason}</td>
      <td>${i.bodega}</td>
      <td><button onclick="delIncident(${i.id})">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
  let tiempoParadas = state.incidents.reduce((s, i) => s + i.minutes, 0);
  document.getElementById('statDowntime').innerText = tiempoParadas;
}
function delIncident(id) {
  state.incidents = state.incidents.filter(i => i.id !== id);
  saveState();
  renderIncidents();
  updateAll();
}
function exportIncidentsCSV() {
  const rows = [["Inicio","Fin","Minutos","Motivo","Bodega"]];
  state.incidents.forEach(i => rows.push([i.start,i.end,i.minutes,i.reason,i.bodega]));
  downloadCSV(rows,"incidentes.csv");
}
function addSindicato() {
  const ficha = document.getElementById('sindFicha').value.trim();
  const no = document.getElementById('sindNo').value.trim();
  const placa = document.getElementById('sindPlaca').value.trim();
  const producto = document.getElementById('sindProducto').value.trim();
  const estatus = document.getElementById('sindEstatus').value;
  if(!ficha || !no) {alert("Ficha y No.listado obligatorios");return;}
  const existe = state.sindicato.some(x => x.ficha === ficha && x.no === no);
  if(existe) {alert("Ya existe esa ficha en ese listado.");return;}
  state.sindicato.push({id: Date.now(), ficha, no, placa, producto, estatus});
  saveState(); renderSindicato();
  document.getElementById('sindFicha').value = '';
  document.getElementById('sindNo').value = '';
  document.getElementById('sindPlaca').value = '';
  document.getElementById('sindProducto').value = '';
}
function importSindicatoCSV() {
  const input = document.getElementById('sindImport');
  if(!input.files.length) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split('\n');
    lines.forEach((line, idx) => {
      if(idx == 0) return;
      const parts = line.split(',');
      if(parts.length >= 5) {
        const ficha = parts[0], no = parts[1], existe = state.sindicato.some(x => x.ficha === ficha && x.no === no);
        if(!existe) {
          state.sindicato.push({id: Date.now(), ficha: parts[0], no: parts[1], placa: parts[2], producto: parts[3], estatus: parts[4]});
        }
      }
    });
    saveState();
    renderSindicato();
  };
  reader.readAsText(input.files[0]);
}
function renderSindicato() {
  const tbody = document.querySelector('#sindTable tbody');
  tbody.innerHTML = '';
  let filterEstatus = document.getElementById('filtrarEstatus').value;
  let list = filterEstatus === "Todos" ? state.sindicato : state.sindicato.filter(s => s.estatus === filterEstatus);
  let totalCargados = list.filter(s => s.estatus === "Cargado").length;
  let totalNoCargados = list.filter(s => s.estatus === "No Cargado").length;
  document.getElementById('totalSindicato').innerText = list.length;
  document.getElementById('totalCargados').innerText = totalCargados;
  document.getElementById('totalNoCargados').innerText = totalNoCargados;
  list.forEach((s, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${s.ficha}</td>
      <td>${s.no}</td>
      <td>${s.placa}</td>
      <td>${s.producto}</td>
      <td>
        <select onchange="updateEstatusSindicato('${s.id}', this.value)">
          <option value="Cargado"${s.estatus == "Cargado" ? " selected" : ""}>Cargado</option>
          <option value="No Cargado"${s.estatus == "No Cargado" ? " selected" : ""}>No Cargado</option>
        </select>
      </td>
      <td><button onclick="delSindicato(${s.id})">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
}
function updateEstatusSindicato(id, val) {
  let idx = state.sindicato.findIndex(s => s.id == id);
  if(idx > -1) {
    state.sindicato[idx].estatus = val;
    saveState();
    renderSindicato();
  }
}
function delSindicato(id) {
  state.sindicato = state.sindicato.filter(s => s.id != id);
  saveState();
  renderSindicato();
}
// DASHBOARD Y CHART
function renderDashboard() {
  let agrupadoM={}, agrupadoD={};
  state.prodManifestados.forEach(x=>{
    let k=x.name+"|"+x.bodega;if(!agrupadoM[k])agrupadoM[k]=0;agrupadoM[k]+=x.manifest;
  });
  state.prodDescargados.forEach(x=>{
    let k=x.name+"|"+x.bodega;if(!agrupadoD[k])agrupadoD[k]=0;agrupadoD[k]+=x.downloaded;
  });
  let tb=document.querySelector('#dashCantTable tbody'); tb.innerHTML='';
  let totalM=0, totalD=0, totalP=0;
  Object.keys(agrupadoM).forEach((k,idx)=>{
    let [prod,bod]=k.split('|');
    let manifiesto=agrupadoM[k];
    let descargado=agrupadoD[k] || 0;
    let pendiente=manifiesto-descargado;
    let pctDesc=manifiesto>0 ? 100*descargado/manifiesto : 0;
    totalM+=manifiesto; totalD+=descargado; totalP+=pendiente;
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${prod}</td>
      <td>${bod}</td>
      <td>${manifiesto.toFixed(2)}</td>
      <td>${descargado.toFixed(2)}</td>
      <td>${pendiente.toFixed(2)}</td>
      <td>${pctDesc.toFixed(1)}%</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('dashTotalManifest').innerText = totalM.toFixed(2);
  document.getElementById('dashTotalDescargado').innerText = totalD.toFixed(2);
  document.getElementById('dashTotalPendiente').innerText = totalP.toFixed(2);
  let h=state.header;
  let opMinutes=h.startOp&&h.endOp?Math.round((new Date(h.endOp)-(new Date(h.startOp)))/60000):0;
  document.getElementById('dashTotalOpTime').innerText=opMinutes>0?(Math.floor(opMinutes/60)+":"+String(opMinutes%60).padStart(2,"0")):'--';
  let motive=document.getElementById('dashFilterReason').value;
  let downs=motive==="Todos"?state.incidents:state.incidents.filter(i=>i.reason===motive);
  let downTime=downs.reduce((s,i)=>s+i.minutes,0);
  document.getElementById('dashDowntime').innerText=downTime;
  document.getElementById('dashTimeNeto').innerText = opMinutes>0?(opMinutes-downTime):'--';
  // Opciones chart
  const sel=document.getElementById('chartProd');
  let allProds=[...new Set(Object.keys(agrupadoM).concat(Object.keys(agrupadoD)).map(x=>x.split('|')[0]))];
  sel.innerHTML='<option value="TODOS">Todos</option>'+allProds.map(x=>`<option value="${x}">${x}</option>`).join('');
}
let chartObj=null;
function renderChart() {
  let ctx=document.getElementById('mainChart').getContext('2d');
  let prod=document.getElementById('chartProd').value;
  let dataM=0,dataD=0,dataP=0;
  let agrupadoM={}, agrupadoD={};
  state.prodManifestados.forEach(x=>{if(prod==="TODOS"||x.name===prod){let k=x.name+"|"+x.bodega;if(!agrupadoM[k])agrupadoM[k]=0;agrupadoM[k]+=x.manifest;}});
  state.prodDescargados.forEach(x=>{if(prod==="TODOS"||x.name===prod){let k=x.name+"|"+x.bodega;if(!agrupadoD[k])agrupadoD[k]=0;agrupadoD[k]+=x.downloaded;}});
  Object.keys(agrupadoM).forEach(k=>{dataM+=agrupadoM[k]; dataD+=(agrupadoD[k]||0);});
  dataP = dataM-dataD;
  if(chartObj)chartObj.destroy();
  chartObj=new Chart(ctx,{
    type:'bar',
    data:{
      labels:["Manifestado","Descargado","Pendiente"],
      datasets:[{label:prod,backgroundColor:["#099","purple","#f8b347"],data:[dataM,dataD,dataP]}]
    },
    options:{
      indexAxis:'y',
      borderRadius:6,
      plugins:{legend: {display:false}},
      scales:{x:{beginAtZero:true},y:{beginAtZero:true}},
      animation:{duration:500},
      elements: { bar: {borderSkipped:false, borderWidth:2, borderColor:'#fff'}}
    }
  });
}
function downloadCSV(rows,filename) {
  let csv=rows.map(r=>r.map(c=>String(c).replace(/"/g,'""')).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download=filename;a.click();
}
</script>
</body>
</html>
