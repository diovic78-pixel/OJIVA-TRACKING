<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tracking Ojiva-Buques</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
  html, body { margin:0; font-family: Inter, Arial, sans-serif; background:#f3f4f6; color:#0f172a; padding:18px;}
  .container { max-width: 1200px; margin:0 auto;}
  .card { background:#fff; border-radius:8px; padding:12px; box-shadow:0 1px 4px rgba(2,6,23,.08); margin-bottom:12px;}
  label { display:block; font-size:13px; color:#54627a; margin-bottom:6px; }
  input, select, textarea { width: 100%; padding:8px; font-size:14px; border-radius:6px; border:1px solid #e6e9ef;}
  button { background:#06b6d4; color:#fff; border:none; padding:8px 20px; border-radius:6px; cursor:pointer;}
  button:disabled { background:#aaa; cursor:default;}
  .grid-2 { display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;}
  .grid-3 { display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;}
  table { width:100%; border-collapse:collapse; font-size:13px; margin-top:8px;}
  th, td { padding:6px; border-bottom:1px solid #eee; text-align:left;}
  #chartContainer { position:fixed; top:15px; right:36px; z-index:20; min-width: 360px; width: 400px; background:#fff; border-radius:14px; box-shadow:0 0 12px #d7d7d7; padding:24px; cursor:move; user-select:none;}
  #chartToggleBtn { position:fixed; top:15px; right:440px; z-index:30;}
  .dash-group { display: flex; gap: 24px; flex-wrap: wrap;}
  .dash-cant { background:#e6f0ff; border-radius: 10px; padding:18px; flex: 3 1 0; min-width:220px;}
  .dash-time { background:#ece2fe; border-radius: 10px; padding:18px; flex: 2 1 0; min-width:160px;}
  select.bodega-select, input.bodega-input { width: 70px !important; font-size:14px; padding:4px; }
  @media (max-width:900px) {
    .container, #chartContainer { width:100%; position:relative; top:auto; right:auto; margin-bottom: 1rem;}
    #chartToggleBtn { position:relative; right:auto; top:auto; margin-bottom: 8px;}
    .dash-group { flex-direction: column;}
  }
</style>
</head>
<body>
<button id="chartToggleBtn" onclick="toggleChart()">Gráfico</button>
<div id="chartContainer">
  <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom:12px;">
    <strong style="font-size:16px;">Gráfico por producto</strong>
    <select id="chartProd" onchange="renderChart()">
      <option value="TODOS">Todos</option>
    </select>
  </div>
  <canvas id="mainChart" width="360" height="220"></canvas>
</div>
<div class="container">
  <h1>Tracking Ojiva-Buques</h1>

  <!-- Ficha general -->
  <div class="card">
    <strong>Ficha general</strong>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Nombre del buque</label><input id="vessel" /></div>
      <div><label>PRESENTACIÓN NOR Fecha - Hora</label><input id="nor" type="datetime-local" /></div>
      <div><label>ETA Fecha - Hora</label><input id="eta" type="datetime-local" /></div>
    </div>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Inicio de operaciones</label><input id="startOp" type="datetime-local" /></div>
      <div><label>Fin de operaciones</label><input id="endOp" type="datetime-local" /></div>
      <div><label>Observaciones generales</label><input id="obsGeneral" /></div>
    </div>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Rata contratada (TM/día)</label><input id="rataContratada" type="number" step="0.01" min="0" /></div>
      <div><label>Condición</label>
        <select id="condicion">
          <option value="SHINC">SHINC</option>
          <option value="SHEX">SHEX</option>
        </select>
      </div>
      <div><label>Inicio Laytime (Fecha y hora)</label><input id="inicioLaytime" type="datetime-local" /></div>
    </div>
    <div class="grid-2" style="margin-top:4px;">
      <div><label>Tiempo Hábil (laytime permitido)</label><input id="tiempoHabil" readonly style="background:#f3f4f6; border:1.5px dashed #bcbcbc;" /></div>
      <div><button style="margin-top:28px;" onclick="calcularLaytime()">Calcular laytime contrato</button>
        <span id="tiempoHabilDetalle" class="muted" style="padding-left:12px;"></span></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="saveHeader()">Guardar ficha</button>
      <button onclick="updateAll()">Actualizar dashboard</button>
      <div class="muted" style="margin-left:auto;">* campos obligatorios</div>
    </div>
  </div>

  <!-- Productos manifestados -->
  <div class="card manifestado">
    <strong>Productos manifestados</strong>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto</label>
        <select id="prodNameM">
          <option value="">Seleccione...</option>
          <option>MAIZ AMERICANO</option>
          <option>MAIZ BRASILENO</option>
          <option>MAIZ ARGENTINO</option>
          <option>HARINA DE SOYA AMERICANA</option>
          <option>HARINA DE SOYA SURAMERICANA</option>
          <option>DNS</option>
          <option>HRW</option>
          <option>SRW</option>
          <option>FRIJOL</option>
          <option>CASCARILLA</option>
        </select>
      </div>
      <div><label>Bodega</label><input id="prodBodegaM" class="bodega-input"/></div>
    </div>
    <div class="grid-2" style="margin-top:4px;">
      <div><label>Cantidad manifestada TM</label><input id="prodManifest" type="number" step="0.01" min="0"/></div>
      <div></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="addProductManifest()">Agregar producto manifestado</button>
      <button onclick="exportProductsMCSV()" style="background:#111827;">Exportar manifestados CSV</button>
      <div class="muted" style="margin-left:auto;">Total manifestados: <span id="prodMCount">0</span></div>
    </div>
    <table id="prodMTable">
      <thead>
        <tr><th>#</th><th>Producto</th><th>Bodega</th><th>Total Manifestado</th><th>Pendiente</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Productos descargados -->
  <div class="card descargado">
    <strong>Productos descargados</strong>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto</label>
        <select id="prodNameD">
          <option value="">Seleccione...</option>
          <option>MAIZ AMERICANO</option>
          <option>MAIZ BRASILENO</option>
          <option>MAIZ ARGENTINO</option>
          <option>HARINA DE SOYA AMERICANA</option>
          <option>HARINA DE SOYA SURAMERICANA</option>
          <option>DNS</option>
          <option>HRW</option>
          <option>SRW</option>
          <option>FRIJOL</option>
          <option>CASCARILLA</option>
        </select>
      </div>
      <div><label>Bodega</label><input id="prodBodegaD" class="bodega-input"/></div>
    </div>
    <div class="grid-2" style="margin-top:4px;">
      <div><label>Cantidad descargada TM</label><input id="prodDownloaded" type="number" step="0.01" min="0"/></div>
      <div></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="addProductDownloaded()">Agregar producto descargado</button>
      <button onclick="exportProductsDCSV()" style="background:#111827;">Exportar descargados CSV</button>
      <div class="muted" style="margin-left:auto;">Total descargados: <span id="prodDCount">0</span></div>
    </div>
    <table id="prodDTable">
      <thead>
        <tr><th>#</th><th>Producto</th><th>Bodega</th><th>Total Descargado</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Registro de paradas -->
  <div class="card">
    <strong>Registro de paradas (incidentes)</strong>
    <div class="grid-2" style="margin-top:8px; max-width:470px;">
      <div>
        <label>Motivo</label>
        <select id="incReason">
          <option value="lluvia">Lluvia</option>
          <option value="movimiento buque">Movimiento Buque</option>
          <option value="paro por mecanizado">Paro por mecanizado</option>
          <option value="falta camiones">Falta camiones</option>
          <option value="problemas buque interno">Problemas buque interno</option>
          <option value="otros">Otros</option>
        </select>
      </div>
      <div>
        <label>Bodega afectada</label>
        <select id="incBodega">
          <option value="Bodega 1">Bodega 1</option>
          <option value="Bodega 2">Bodega 2</option>
          <option value="Buque completo">Buque completo</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <button onclick="inicioIncidente()">Inicio incidente</button>
      <button onclick="finIncidente()">Fin incidente</button>
      <button onclick="exportIncidentsCSV()" style="background:#111827;">Exportar CSV</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <strong>Tiempo total de paradas: <span id="statDowntime">0</span> min</strong>
      <span>
        Filtrar motivo:
        <select id="filterReason" onchange="updateAll()">
          <option value="Todos">Todos</option>
          <option value="lluvia">Lluvia</option>
          <option value="movimiento buque">Movimiento Buque</option>
          <option value="paro por mecanizado">Paro por mecanizado</option>
          <option value="falta camiones">Falta camiones</option>
          <option value="problemas buque interno">Problemas buque interno</option>
          <option value="otros">Otros</option>
        </select>
        <strong style="margin-left:10px;">Total motivo: <span id="statDowntimeFilter">0</span> min</strong>
      </span>
    </div>
    <table id="incTable">
      <thead>
        <tr><th>#</th><th>Inicio</th><th>Fin</th><th>Minutos</th><th>Motivo</th><th>Bodega</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Sindicato -->
  <div class="card">
    <strong>Listado sindicato (fichas)</strong>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Ficha</label><input id="sindFicha" /></div>
      <div><label>No. listado</label><input id="sindNo" /></div>
      <div><label>Placa</label><input id="sindPlaca" /></div>
    </div>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto a cargar</label><input id="sindProducto" /></div>
      <div style="align-self:end;">
        <label>Estatus</label>
        <select id="sindEstatus" onchange="toggleSindBodegaInput()">
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
        <span id="sindBodegaBox"></span>
        <button onclick="addSindicato()">Agregar</button>
        <input type="file" id="sindImport" accept=".csv" onchange="importSindicatoCSV()" style="margin-top:6px;" />
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <strong>Total camiones: <span id="totalSindicato">0</span></strong>
      <span class="muted">
        Filtrar por estatus: 
        <select id="filtrarEstatus" onchange="renderSindicato()">
          <option value="Todos">Todos</option>
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
        <span style="margin-left:10px;">Cargados: <strong id="totalCargados">0</strong></span>
        <span style="margin-left:10px;">No cargados: <strong id="totalNoCargados">0</strong></span>
      </span>
    </div>
    <table id="sindTable">
      <thead>
        <tr><th>#</th><th>Ficha</th><th>No.Listado</th><th>Placa</th><th>Producto</th><th>Estatus</th><th>Bodega</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Dashboard y resumen -->
  <div class="card">
    <strong>Dashboard y Resumen ejecutivo</strong>
    <div class="dash-group" style="margin-top:14px;flex-wrap:wrap;">
      <div class="dash-cant" style="min-width: 270px;">
        <strong>Cantidades por producto y bodega</strong>
        <table class="dash-cant-table" id="dashCantTable">
          <thead>
            <tr><th>Producto</th><th>Bodega</th><th>Manifestado</th><th>Descargado</th><th>Pendiente</th><th>% Descargado</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px;font-size:14px;">
          <strong>Total manifestado:</strong> <span id="dashTotalManifest">0</span> TM<br>
          <strong>Total descargado:</strong> <span id="dashTotalDescargado">0</span> TM<br>
          <strong>Total pendiente:</strong> <span id="dashTotalPendiente">0</span> TM
        </div>
      </div>
      <div class="dash-time" style="min-width: 190px;">
        <strong>Resumen tiempos</strong>
        <div style="margin:5px 0 0 0; font-size:14px;">
          <strong>Bruto (inicio-fin):</strong> <span id="dashTotalOpTime">--:--</span>
        </div>
        <div style="margin:6px 0 0 0; font-size:14px;">
          <strong>Total paradas:</strong> <span id="dashDowntime">0</span> min
        </div>
        <div style="margin:6px 0 0 0; font-size:14px;">
          <strong>Tiempo neto operativo:</strong> <span id="dashTimeNeto">0</span> min
        </div>
        <div style="margin:6px 0 0 0; font-size:14px;">
          Filtrar paradas por motivo: 
          <select id="dashFilterReason" onchange="updateAll()">
            <option value="Todos">Todos</option>
            <option value="lluvia">Lluvia</option>
            <option value="movimiento buque">Movimiento Buque</option>
            <option value="paro por mecanizado">Paro por mecanizado</option>
            <option value="falta camiones">Falta camiones</option>
            <option value="problemas buque interno">Problemas buque interno</option>
            <option value="otros">Otros</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
  const feriadosRD2025 = [
    "2025-01-01", "2025-01-06", "2025-01-21", "2025-01-26", "2025-02-27", "2025-03-24",
    "2025-04-18", "2025-05-01", "2025-05-30", "2025-06-03", "2025-08-16", "2025-09-24", "2025-12-25"
  ];

  let state = {header:{},prodManifestados:[],prodDescargados:[],incidents:[],sindicato:[]};
  const DBKEY = 'trackingdescarga_prod_bod_dashboard';
  const PW_AUTORIZA = "AUTORIZADO2025";

  window.onload = function() {
    const raw = localStorage.getItem(DBKEY);
    if(raw) state = JSON.parse(raw);
    toggleSindBodegaInput();
    makeDraggable(document.getElementById('chartContainer'));
    updateAll();
  };

  // draggable box for chart
  function makeDraggable(el) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    el.onmousedown = dragMouseDown;
    function dragMouseDown(e) {
      e.preventDefault();
      pos3 = e.clientX; pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
      e.preventDefault();
      pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
      pos3 = e.clientX; pos4 = e.clientY;
      el.style.top = (el.offsetTop - pos2) + "px";
      el.style.left = (el.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  // toggle chart container
  function toggleChart() {
    const c = document.getElementById('chartContainer');
    c.style.display = c.style.display === 'none' ? 'block' : 'none';
  }

  function saveState() { localStorage.setItem(DBKEY,JSON.stringify(state)); }

  // Save and update header/ficha general
  function saveHeader() {
    state.header = {
      vessel: document.getElementById('vessel').value.trim(),
      nor: document.getElementById('nor').value,
      eta: document.getElementById('eta').value,
      startOp: document.getElementById('startOp').value,
      endOp: document.getElementById('endOp').value,
      obs: document.getElementById('obsGeneral').value,
      rata: parseFloat(document.getElementById('rataContratada').value||0),
      condicion: document.getElementById('condicion').value,
      inicioLaytime: document.getElementById('inicioLaytime').value
    };
    saveState(); updateAll();
  }

  // Cálculo laytime
  function calcularLaytime() {
    let total = getTotalManifestadoGlobal();
    let rata = parseFloat(document.getElementById('rataContratada').value || 0);
    let condicion = document.getElementById('condicion').value;
    let inicioLay = document.getElementById('inicioLaytime').value;

    if (total === 0 || rata === 0 || !inicioLay) {
      document.getElementById('tiempoHabil').value = "";
      document.getElementById('tiempoHabilDetalle').innerText = "Faltan datos o rata/laytime es 0";
      return;
    }
    let diasLaytimeExacto = total / rata;
    let fechaInicioLay = new Date(inicioLay);
    let minHabil = Math.floor(diasLaytimeExacto*24*60);
    let diasSumar = 0;
    if(condicion==="SHEX"){
      let fechaFin = new Date(fechaInicioLay.getTime() + (minHabil*60000));
      let extras = contarDiasDomingoFeriado(fechaInicioLay, fechaFin);
      diasSumar = extras;
      minHabil += extras*24*60;
    }
    let minLluvia = getMinutosParadaLluviaDesde(fechaInicioLay);
    minHabil += minLluvia;
    let dias = Math.floor(minHabil/1440);
    let horas = Math.floor((minHabil%1440)/60);
    let mins = minHabil%60;
    document.getElementById('tiempoHabil').value = `${dias} días, ${horas}h, ${mins}m`;
    let detalles = `(Incluye SHEX: ${diasSumar}d, lluvia: ${Math.round(minLluvia/60)}h)`;
    document.getElementById('tiempoHabilDetalle').innerText = detalles;
  }

  function contarDiasDomingoFeriado(fecha1, fecha2){
    let count = 0;
    for(let d=new Date(fecha1); d<=fecha2; d.setDate(d.getDate()+1)){
      let iso = d.toISOString().slice(0,10);
      if(d.getDay()===0 || feriadosRD2025.indexOf(iso) >= 0) count++;
    }
    return count;
  }

  function getMinutosParadaLluviaDesde(desdeFecha){
    let desdeT=desdeFecha.getTime();
    return (state.incidents||[]).filter(i=>i.reason==="lluvia"&&new Date(i.start) >= desdeT)
            .reduce((s,i)=>s+(i.minutes||0),0);
  }

  function getTotalManifestadoGlobal(){
    return state.prodManifestados.reduce((s,x)=>s+(x.manifest||0),0);
  }

  // Código restante igual que antes para manejo productos, incidentes, sindicato, export, etc.

  // Expo CSV (productos manifestados)
  function exportProductsMCSV() {
    const rows=[["Producto","Bodega","Manifestado (TM)"]];
    state.prodManifestados.forEach(p=>rows.push([p.name,p.bodega,p.manifest]));
    downloadCSV(rows,"manifestados.csv");
  }

  // Export CSV (productos descargados)
  function exportProductsDCSV() {
    const rows=[["Producto","Bodega","Descargado (TM)"]];
    state.prodDescargados.forEach(p=>rows.push([p.name,p.bodega,p.downloaded]));
    downloadCSV(rows,"descargados.csv");
  }

  // Export CSV incidentes
  function exportIncidentsCSV() {
    const rows = [["Inicio","Fin","Minutos","Motivo","Bodega"]];
    state.incidents.forEach(i => rows.push([i.start, i.end, i.minutes, i.reason, i.bodega]));
    downloadCSV(rows,"incidentes.csv");
  }

  // Función utilitaria CSV
  function downloadCSV(rows,filename){
    let csv=rows.map(r=>r.map(c=>String(c).replace(/"/g,'""')).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);a.download=filename;a.click();
  }

  // Las demás funciones (productos, render, actualizar, incidentes, sindicato, dashboard y chart) son iguales que la versión previa, manteniendo funcionalidad y validaciones

</script>
</body>
</html>
