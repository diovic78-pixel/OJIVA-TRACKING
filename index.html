<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tracking Ojiva-Buques</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
  html, body {margin: 0; font-family: Inter, Arial, sans-serif; background: #f3f4f6; color: #0f172a; padding: 18px;}
  .container {max-width: 1200px; margin: 0 auto;}
  .card {border-radius: 8px; padding: 12px; box-shadow: 0 1px 4px rgba(2,6,23,.08); margin-bottom: 12px;}
  label {display: block; font-size: 13px; margin-bottom: 6px;}
  input, select, textarea, button {font-size: 14px; border-radius: 6px;}
  input, select, textarea {padding: 8px; border: 1px solid #e6e9ef;}
  input[type="text"], input[type="number"], input[type="datetime-local"], textarea {width: 100%;}
  select:not(.bodega-select) {width: 100%;}
  .bodega-input, select.bodega-select {max-width: 80px; width: auto;}
  .producto-input {max-width: 220px;}
  .respuesta-corta {max-width: 180px;}
  button {background: #06b6d4; color: white; padding: 8px 20px; border: none;}
  button:disabled {background: #aaa; cursor: default;}
  table {width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px;}
  th, td {padding: 6px; border-bottom: 1px solid #eee; text-align: left;}
  .muted {color: #6b7280; font-size: 13px;}
  #chartContainer {position: fixed; top: 15px; right: 36px; z-index: 20; min-width: 360px; width: 400px; background: #fff; border-radius: 14px; box-shadow: 0 0 12px #d7d7d7; padding: 24px; cursor: move; display:none;}
  #chartToggleBtn {position: fixed; top: 15px; right: 460px; z-index: 30;}
  .dash-group {display: flex; gap: 24px; flex-wrap: wrap;}
  .dash-cant {background: #e5f3ff; border-radius: 10px; padding: 18px; flex: 3 1 0; min-width: 270px;}
  .dash-time {background: #f3e7ff; border-radius: 10px; padding: 18px; flex: 2 1 0; min-width: 190px;}
  .card.ficha-general {background-color: #def3ff;}
  .card.manifestado {background-color: #e9f5eb;}
  .card.descargado {background-color: #f2e9ff;}
  .card.mecanizado {background-color: #fff4e0;}
  .card.dashboard {background-color: #eef6fa;}
  .card.resumen-ejecutivo {background-color: #fbe0f0;}
  .grid-3, .grid-2 {display: grid; gap: 12px;}
  .grid-3 {grid-template-columns: repeat(3, 1fr);}
  .grid-2 {grid-template-columns: repeat(2, 1fr);}
  @media (max-width: 900px) {
    .container, #chartContainer, #chartToggleBtn {width: 100%; position: relative; top:auto; right:auto; margin-bottom: 1rem;}
    .dash-group {flex-direction: column;}
    .grid-3, .grid-2 {grid-template-columns: 1fr;}
  }
</style>
</head>
<body>
<button id="chartToggleBtn" onclick="toggleChart()">Gráfico</button>
<div id="chartContainer">
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
    <strong style="font-size: 16px;">Gráfico por producto</strong>
    <select id="chartProd" onchange="renderChart()"><option value="TODOS">Todos</option></select>
  </div>
  <canvas id="mainChart" width="360" height="220"></canvas>
</div>
<div class="container">
  <h1>Tracking Ojiva-Buques</h1>
  <div class="card ficha-general">
    <strong>Ficha general</strong>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Nombre del buque</label><input id="vessel" class="producto-input" /></div>
      <div><label>PRESENTACIÓN NOR Fecha - Hora</label><input id="nor" type="datetime-local" class="respuesta-corta"/></div>
      <div><label>ETA Fecha - Hora</label><input id="eta" type="datetime-local" class="respuesta-corta"/></div>
      <div><label>Inicio de operaciones</label><input id="startOp" type="datetime-local" class="respuesta-corta"/></div>
      <div><label>Fin de operaciones</label><input id="endOp" type="datetime-local" class="respuesta-corta"/></div>
      <div><label>Observaciones generales</label><input id="obsGeneral" /></div>
      <div><label>Rata contratada (TM/día)</label><input id="rataContratada" type="number" step="0.01" min="0" class="respuesta-corta"/></div>
      <div><label>Condición</label><select id="condicion" class="respuesta-corta"><option value="SHINC">SHINC</option><option value="SHEX">SHEX</option></select></div>
      <div><label>Inicio Laytime (Fecha y hora)</label><input id="inicioLaytime" type="datetime-local" class="respuesta-corta"/></div>
      <div><label>Tiempo Hábil (laytime permitido)</label><input id="tiempoHabil" readonly style="background:#f3f4f6; border:1.5px dashed #bcbcbc;"/></div>
      <div><button style="margin-top:28px;" onclick="calcularLaytime()">Calcular laytime contrato</button></div>
      <div><span id="tiempoHabilDetalle" class="muted" style="padding-left:12px;"></span></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="saveHeader()">Guardar ficha</button>
      <button onclick="updateAll()">Actualizar dashboard</button>
      <div class="muted" style="margin-left:auto;">* campos obligatorios</div>
    </div>
  </div>
  <div class="card manifestado">
    <strong>Productos manifestados</strong>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto</label>
        <select id="prodNameM" class="producto-input"><option value="">Seleccione...</option><option>MAIZ AMERICANO</option><option>MAIZ BRASILENO</option><option>MAIZ ARGENTINO</option><option>HARINA DE SOYA AMERICANA</option><option>HARINA DE SOYA SURAMERICANA</option><option>DNS</option><option>HRW</option><option>SRW</option><option>FRIJOL</option><option>CASCARILLA</option></select>
      </div>
      <div><label>Bodega</label><select id="prodBodegaM" class="bodega-select"><option value="">Seleccione...</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
    </div>
    <div class="grid-2" style="margin-top:4px;">
      <div><label>Cantidad manifestada TM</label><input id="prodManifest" type="number" step="0.01" min="0" class="respuesta-corta"/></div>
      <div></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="addProductManifest()">Agregar producto manifestado</button>
      <button onclick="exportProductsMCSV()" style="background:#111827;">Exportar manifestados CSV</button>
      <div class="muted" style="margin-left:auto;">Total manifestados: <span id="prodMCount">0</span></div>
    </div>
    <table id="prodMTable">
      <thead><tr><th>#</th><th>Producto</th><th>Bodega</th><th>Total Manifestado</th><th>Pendiente</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card descargado">
    <strong>Productos descargados</strong>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto</label>
        <select id="prodNameD" class="producto-input"><option value="">Seleccione...</option><option>MAIZ AMERICANO</option><option>MAIZ BRASILENO</option><option>MAIZ ARGENTINO</option><option>HARINA DE SOYA AMERICANA</option><option>HARINA DE SOYA SURAMERICANA</option><option>DNS</option><option>HRW</option><option>SRW</option><option>FRIJOL</option><option>CASCARILLA</option></select>
      </div>
      <div><label>Bodega</label><select id="prodBodegaD" class="bodega-select"><option value="">Seleccione...</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
    </div>
    <div class="grid-2" style="margin-top:4px;">
      <div><label>Cantidad descargada TM</label><input id="prodDownloaded" type="number" step="0.01" min="0" class="respuesta-corta" /></div>
      <div></div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center;">
      <button onclick="addProductDownloaded()">Agregar producto descargado</button>
      <button onclick="exportProductsDCSV()" style="background:#111827;">Exportar descargados CSV</button>
      <div class="muted" style="margin-left:auto;">Total descargados: <span id="prodDCount">0</span></div>
    </div>
    <table id="prodDTable">
      <thead><tr><th>#</th><th>Producto</th><th>Bodega</th><th>Total Descargado</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="card mecanizado" style="margin-top:12px;">
      <strong>Mecanizado (descarga por línea y hora)</strong>
      <div class="grid-2" style="margin:12px 0;">
        <div>
          <label>Línea</label>
          <select id="mecanLinea" class="bodega-select" style="margin-right:6px;"><option>1</option><option>2</option></select>
        </div>
        <div>
          <label>Toneladas</label>
          <input id="mecanTM" type="number" min="0" step="0.01" class="respuesta-corta" />
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <button onclick="addMecanizado()">Agregar registro</button>
        <button onclick="generarPromedioMecanizado()">Generar promedio</button>
        <div class="muted" id="promedioMecanizado"></div>
      </div>
      <table id="mecanizadoTable">
        <thead><tr><th>Línea</th><th>Toneladas</th><th>Hora</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <strong>Registro de paradas (incidentes)</strong>
    <div class="grid-2" style="margin-top:8px; max-width:470px;">
      <div>
        <label>Motivo</label>
        <select id="incReason" class="producto-input">
          <option value="lluvia">Lluvia</option>
          <option value="movimiento buque">Movimiento Buque</option>
          <option value="paro por mecanizado">Paro por mecanizado</option>
          <option value="falta camiones">Falta camiones</option>
          <option value="problemas buque interno">Problemas buque interno</option>
          <option value="otros">Otros</option>
        </select>
      </div>
      <div>
        <label>Bodega afectada</label>
        <select id="incBodega" class="bodega-select"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>Buque completo</option></select>
      </div>
    </div>
    <div style="margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <button onclick="inicioIncidente()">Inicio incidente</button>
      <button onclick="finIncidente()">Fin incidente</button>
      <button onclick="exportIncidentsCSV()" style="background:#111827;">Exportar CSV</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <strong>Tiempo total de paradas: <span id="statDowntime">0</span> min</strong>
      <span>
        Filtrar motivo:
        <select id="filterReason" onchange="updateAll()" class="producto-input">
          <option value="Todos">Todos</option>
          <option value="lluvia">Lluvia</option>
          <option value="movimiento buque">Movimiento Buque</option>
          <option value="paro por mecanizado">Paro por mecanizado</option>
          <option value="falta camiones">Falta camiones</option>
          <option value="problemas buque interno">Problemas buque interno</option>
          <option value="otros">Otros</option>
        </select>
        <strong style="margin-left:10px;">Total motivo: <span id="statDowntimeFilter">0</span> min</strong>
      </span>
    </div>
    <table id="incTable">
      <thead>
        <tr><th>#</th><th>Inicio</th><th>Fin</th><th>Minutos</th><th>Motivo</th><th>Bodega</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card">
    <strong>Listado sindicato (fichas)</strong>
    <div class="grid-3" style="margin-top:8px;">
      <div><label>Ficha</label><input id="sindFicha" class="respuesta-corta"/></div>
      <div><label>No. listado</label><input id="sindNo" class="respuesta-corta"/></div>
      <div><label>Placa</label><input id="sindPlaca" class="respuesta-corta"/></div>
    </div>
    <div class="grid-2" style="margin-top:8px;">
      <div><label>Producto a cargar</label><input id="sindProducto" class="producto-input"/></div>
      <div style="align-self:end;">
        <label>Estatus</label>
        <select id="sindEstatus" onchange="toggleSindBodegaInput()" class="respuesta-corta">
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
        <span id="sindBodegaBox"></span>
        <button onclick="addSindicato()">Agregar</button>
        <input type="file" id="sindImport" accept=".csv" onchange="importSindicatoCSV()" style="margin-top:6px;" />
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <strong>Total camiones: <span id="totalSindicato">0</span></strong>
      <span class="muted">
        Filtrar por estatus:
        <select id="filtrarEstatus" onchange="renderSindicato()" class="respuesta-corta">
          <option value="Todos">Todos</option>
          <option value="Cargado">Cargado</option>
          <option value="No Cargado">No Cargado</option>
        </select>
        <span style="margin-left: 10px;">Cargados: <strong id="totalCargados">0</strong></span>
        <span style="margin-left: 10px;">No cargados: <strong id="totalNoCargados">0</strong></span>
      </span>
    </div>
    <table id="sindTable">
      <thead>
        <tr><th>#</th><th>Ficha</th><th>No.Listado</th><th>Placa</th><th>Producto</th><th>Estatus</th><th>Bodega</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card dashboard">
    <strong>Dashboard y Resumen ejecutivo</strong>
    <div class="dash-group" style="margin-top: 14px; flex-wrap: wrap;">
      <div class="dash-cant" style="min-width: 270px;">
        <strong>Cantidades por producto y bodega</strong>
        <table class="dash-cant-table" id="dashCantTable">
          <thead>
            <tr><th>Producto</th><th>Bodega</th><th>Manifestado</th><th>Descargado</th><th>Pendiente</th><th>% Descargado</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top: 8px; font-size: 14px;">
          <strong>Total manifestado:</strong> <span id="dashTotalManifest">0</span> TM<br/>
          <strong>Total descargado:</strong> <span id="dashTotalDescargado">0</span> TM<br/>
          <strong>Total pendiente:</strong> <span id="dashTotalPendiente">0</span> TM
        </div>
      </div>
      <div class="dash-time" style="min-width: 190px;">
        <strong>Resumen tiempos</strong>
        <div style="margin: 5px 0 0 0; font-size: 14px;">
          <strong>Bruto (inicio-fin):</strong> <span id="dashTotalOpTime">--:--</span>
        </div>
        <div style="margin: 6px 0 0 0; font-size: 14px;">
          <strong>Total paradas:</strong> <span id="dashDowntime">0</span> min
        </div>
        <div style="margin: 6px 0 0 0; font-size: 14px;">
          <strong>Tiempo neto operativo:</strong> <span id="dashTimeNeto">0</span> min
        </div>
        <div style="margin: 6px 0 0 0; font-size: 14px;">
          Filtrar paradas por motivo:
          <select id="dashFilterReason" onchange="updateAll()" class="producto-input">
            <option value="Todos">Todos</option>
            <option value="lluvia">Lluvia</option>
            <option value="movimiento buque">Movimiento Buque</option>
            <option value="paro por mecanizado">Paro por mecanizado</option>
            <option value="falta camiones">Falta camiones</option>
            <option value="problemas buque interno">Problemas buque interno</option>
            <option value="otros">Otros</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="card resumen-ejecutivo" style="margin-bottom:22px;">
    <strong>RESUMEN EJECUTIVO</strong>
    <div style="margin-top:9px;font-size:15px;" id="boxResumenEjecutivo"></div>
  </div>
</div>

<script>
const feriadosRD2025 = ["2025-01-01","2025-01-06","2025-01-21","2025-01-26","2025-02-27","2025-03-24","2025-04-18","2025-05-01","2025-05-30","2025-06-03","2025-08-16","2025-09-24","2025-12-25"];

let state = {header:{},prodManifestados:[],prodDescargados:[],incidents:[],sindicato:[], mecanizado:[]};
const DBKEY = 'trackingdescarga_prod_bod_dashboard';
const PW_AUTORIZA = "AUTORIZADO2025";

window.onload = function() {
  const raw = localStorage.getItem(DBKEY);
  if(raw) state = JSON.parse(raw);
  toggleSindBodegaInput();
  makeDraggable(document.getElementById('chartContainer'));
  updateAll();
};

function makeDraggable(el) {
  let pos1=0, pos2=0, pos3=0, pos4=0;
  el.onmousedown = dragMouseDown;
  function dragMouseDown(e) {
    e.preventDefault();
    pos3 = e.clientX; pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }
  function elementDrag(e) {
    e.preventDefault();
    pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
    pos3 = e.clientX; pos4 = e.clientY;
    el.style.top = (el.offsetTop - pos2) + "px";
    el.style.left = (el.offsetLeft - pos1) + "px";
  }
  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

function toggleChart() {
  const c = document.getElementById('chartContainer');
  c.style.display = (c.style.display === 'none' || c.style.display === '') ? 'block' : 'none';
}

function saveState() { localStorage.setItem(DBKEY, JSON.stringify(state)); }

function saveHeader() {
  state.header = {
    vessel: document.getElementById('vessel').value.trim(),
    nor: document.getElementById('nor').value,
    eta: document.getElementById('eta').value,
    startOp: document.getElementById('startOp').value,
    endOp: document.getElementById('endOp').value,
    obs: document.getElementById('obsGeneral').value,
    rata: parseFloat(document.getElementById('rataContratada').value || 0),
    condicion: document.getElementById('condicion').value,
    inicioLaytime: document.getElementById('inicioLaytime').value
  };
  saveState(); updateAll();
}

function calcularLaytime() {
  let total = getTotalManifestadoGlobal();
  let rata = parseFloat(document.getElementById('rataContratada').value || 0);
  let condicion = document.getElementById('condicion').value;
  let inicioLay = document.getElementById('inicioLaytime').value;
  if (total === 0 || rata === 0 || !inicioLay) {
    document.getElementById('tiempoHabil').value = "";
    document.getElementById('tiempoHabilDetalle').innerText = "Faltan datos o rata/laytime es 0";
    return;
  }
  let diasLaytimeExacto = total / rata;
  let fechaInicioLay = new Date(inicioLay);
  let minHabil = Math.floor(diasLaytimeExacto * 24 * 60);
  let diasSumar = 0;
  if (condicion === "SHEX") {
    let fechaFin = new Date(fechaInicioLay.getTime() + minHabil * 60000);
    diasSumar = contarDiasDomingoFeriado(fechaInicioLay, fechaFin);
    minHabil += diasSumar * 24 * 60;
  }
  let minLluvia = getMinutosParadaLluviaDesde(fechaInicioLay);
  minHabil += minLluvia;
  let dias = Math.floor(minHabil / 1440);
  let horas = Math.floor((minHabil % 1440) / 60);
  let mins = minHabil % 60;
  document.getElementById('tiempoHabil').value = `${dias} días, ${horas}h, ${mins}m`;
  document.getElementById('tiempoHabilDetalle').innerText = `(Incluye SHEX: ${diasSumar}d, lluvia: ${Math.round(minLluvia / 60)}h)`;
}

function contarDiasDomingoFeriado(fecha1, fecha2) {
  let count = 0;
  for (let d = new Date(fecha1); d <= fecha2; d.setDate(d.getDate() + 1)) {
    let iso = d.toISOString().slice(0, 10);
    if (d.getDay() === 0 || feriadosRD2025.indexOf(iso) >= 0) count++;
  }
  return count;
}

function getMinutosParadaLluviaDesde(desdeFecha) {
  let desdeT = desdeFecha.getTime();
  return (state.incidents || []).filter(i => i.reason === "lluvia" && new Date(i.start) >= desdeT)
    .reduce((s, i) => s + (i.minutes || 0), 0);
}

function getTotalManifestadoGlobal() {
  return state.prodManifestados.reduce((s, x) => s + (x.manifest || 0), 0);
}

function addProductManifest() {
  const name = document.getElementById('prodNameM').value;
  const bodega = document.getElementById('prodBodegaM').value;
  const manifest = parseFloat(document.getElementById('prodManifest').value || 0);
  if (!name || name === '') {
    alert('Debe seleccionar un producto (no dejar en "Seleccione...").');
    return;
  }
  if (!bodega || bodega === "Seleccione...") {
    alert('Bodega es obligatoria.');
    return;
  }
  if (manifest <= 0) {
    alert('Cantidad manifestada debe ser > 0.');
    return;
  }
  state.prodManifestados.push({ id: Date.now(), name, bodega, manifest });
  saveState();
  renderProductsManifest();
  renderDashboard();
  renderChart();
  document.getElementById('prodNameM').value = '';
  document.getElementById('prodManifest').value = '';
  document.getElementById('prodBodegaM').value = '';
}

function addProductDownloaded() {
  const name = document.getElementById('prodNameD').value;
  const bodega = document.getElementById('prodBodegaD').value;
  const downloaded = parseFloat(document.getElementById('prodDownloaded').value || 0);
  if (!name || name === '') {
    alert('Debe seleccionar un producto (no dejar en "Seleccione...").');
    return;
  }
  if (!bodega || bodega === "Seleccione...") {
    alert('Bodega es obligatoria.');
    return;
  }
  if (downloaded <= 0) {
    alert('Cantidad descargada inválida.');
    return;
  }
  const totalManifestado = getTotalManifestado(name, bodega);
  const totalDescargadoPrevio = getTotalDescargado(name, bodega);
  if (totalManifestado < (downloaded + totalDescargadoPrevio)) {
    const excede = (downloaded + totalDescargadoPrevio) - totalManifestado;
    let clave = prompt('Descargado excede lo manifestado por ' + excede + ' TM. Ingresa clave de autorización:');
    if (clave !== PW_AUTORIZA) {
      alert('No autorizado. Contacte supervisor.');
      return;
    }
  }
  state.prodDescargados.push({ id: Date.now(), name, bodega, downloaded });
  saveState();
  renderProductsDownloaded();
  renderDashboard();
  renderChart();
  document.getElementById('prodNameD').value = '';
  document.getElementById('prodDownloaded').value = '';
  document.getElementById('prodBodegaD').value = '';
}

function renderProductsManifest() {
  const tbody = document.querySelector('#prodMTable tbody');
  tbody.innerHTML = '';
  let agrupado = {};
  state.prodManifestados.forEach(x => {
    let k = x.name + "|" + x.bodega;
    agrupado[k] = (agrupado[k] || 0) + x.manifest;
  });
  let rows = Object.entries(agrupado);
  rows.forEach(([key, manifest], idx) => {
    let [prod, bodega] = key.split('|');
    let descargado = getTotalDescargado(prod, bodega);
    let pendiente = manifest - descargado;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${prod}</td>
      <td>${bodega}</td>
      <td>${manifest.toFixed(2)}</td>
      <td>${pendiente.toFixed(2)}</td>
      <td><button onclick="delProductManifest('${prod}','${bodega}')">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('prodMCount').innerText = rows.length;
}

function getTotalManifestado(name, bodega) {
  return state.prodManifestados.filter(x => x.name === name && x.bodega === bodega)
    .reduce((s, p) => s + p.manifest, 0);
}

function getTotalDescargado(name, bodega) {
  return state.prodDescargados.filter(x => x.name === name && x.bodega === bodega)
    .reduce((s, p) => s + p.downloaded, 0);
}

function delProductManifest(prod, bodega) {
  state.prodManifestados = state.prodManifestados.filter(x => !(x.name === prod && x.bodega === bodega));
  saveState();
  renderProductsManifest();
  renderDashboard();
  renderChart();
}

function renderProductsDownloaded() {
  const tbody = document.querySelector('#prodDTable tbody');
  tbody.innerHTML = '';
  let agrupado = {};
  state.prodDescargados.forEach(x => {
    let k = x.name + "|" + x.bodega;
    agrupado[k] = (agrupado[k] || 0) + x.downloaded;
  });
  Object.entries(agrupado).forEach(([key, downloaded], idx) => {
    let [prod, bodega] = key.split('|');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${prod}</td>
      <td>${bodega}</td>
      <td>${downloaded.toFixed(2)}</td>
      <td><button onclick="delProductDownloaded('${prod}','${bodega}')">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('prodDCount').innerText = Object.keys(agrupado).length;
}

function delProductDownloaded(prod, bodega) {
  state.prodDescargados = state.prodDescargados.filter(x => !(x.name === prod && x.bodega === bodega));
  saveState();
  renderProductsDownloaded();
  renderDashboard();
  renderChart();
}

function addMecanizado() {
  let linea = document.getElementById('mecanLinea').value;
  let tm = parseFloat(document.getElementById('mecanTM').value || 0);
  let ahora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  if (!linea) return;
  if (tm <= 0) { alert("Ingrese ton correctas."); return; }
  state.mecanizado.push({id: Date.now(), linea, tm, hora: ahora});
  saveState();
  updateAll();
  document.getElementById('mecanTM').value = '';
}

function renderMecanizado() {
  let tb = document.getElementById('mecanizadoTable').getElementsByTagName('tbody')[0];
  tb.innerHTML = '';
  state.mecanizado.forEach((m, idx) => {
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.linea}</td><td>${m.tm.toFixed(2)}</td><td>${m.hora}</td><td><button onclick="delMecanizado(${m.id})">Eliminar</button></td>`;
    tb.appendChild(tr);
  });
}

function delMecanizado(id) {
  state.mecanizado = state.mecanizado.filter(x => x.id != id);
  saveState();
  updateAll();
}

function generarPromedioMecanizado() {
  let sum = state.mecanizado.reduce((s, x) => s + x.tm, 0);
  let n = state.mecanizado.length;
  let promedio = n > 0 ? sum / n : 0;
  document.getElementById('promedioMecanizado').innerText = promedio > 0 ? ("Prom.: " + promedio.toFixed(2) + " t/h") : '';
  return promedio;
}

function toggleSindBodegaInput() {
  const estatus = document.getElementById('sindEstatus').value;
  const box = document.getElementById('sindBodegaBox');
  if (estatus === "Cargado") {
    box.innerHTML = '<label style="display:inline; font-size:13px;">Bodega</label><select id="sindBodega" class="bodega-select"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>';
  } else { box.innerHTML = ''; }
}

function addSindicato() {
  const ficha = document.getElementById('sindFicha').value.trim();
  const no = document.getElementById('sindNo').value.trim();
  const placa = document.getElementById('sindPlaca').value.trim();
  const producto = document.getElementById('sindProducto').value.trim();
  const estatus = document.getElementById('sindEstatus').value;
  let bodega = '';
  if (estatus === 'Cargado') {
    const sel = document.getElementById('sindBodega');
    if (!sel) { alert('Debe elegir una bodega para camión cargado.'); return; }
    bodega = sel.value;
  }
  if (!ficha || !no) {
    alert('Ficha y No.listado obligatorios');
    return;
  }
  const existe = state.sindicato.some(x => x.ficha === ficha && x.no === no);
  if (existe) {
    alert('Ya existe esa ficha en ese listado.');
    return;
  }
  state.sindicato.push({ id: Date.now(), ficha, no, placa, producto, estatus, bodega });
  saveState();
  renderSindicato();
  document.getElementById('sindFicha').value = '';
  document.getElementById('sindNo').value = '';
  document.getElementById('sindPlaca').value = '';
  document.getElementById('sindProducto').value = '';
  toggleSindBodegaInput();
}

function importSindicatoCSV() {
  const input = document.getElementById('sindImport');
  if (!input.files.length) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const lines = e.target.result.split('\n');
    lines.forEach((line, idx) => {
      if (idx == 0) return;
      const parts = line.split(',');
      if (parts.length >= 6) {
        const ficha = parts[0], no = parts[1], existe = state.sindicato.some(x => x.ficha === ficha && x.no === no);
        if (!existe) {
          state.sindicato.push({ id: Date.now(), ficha: parts[0], no: parts[1], placa: parts[2], producto: parts[3], estatus: parts[4], bodega: parts[5] });
        }
      }
    });
    saveState();
    renderSindicato();
  };
  reader.readAsText(input.files[0]);
}

function renderSindicato() {
  const tbody = document.querySelector('#sindTable tbody');
  tbody.innerHTML = '';
  let filterEstatus = document.getElementById('filtrarEstatus').value;
  let list = filterEstatus === "Todos" ? state.sindicato : state.sindicato.filter(s => s.estatus === filterEstatus);
  let totalCargados = list.filter(s => s.estatus === "Cargado").length;
  let totalNoCargados = list.filter(s => s.estatus === "No Cargado").length;
  document.getElementById('totalSindicato').innerText = list.length;
  document.getElementById('totalCargados').innerText = totalCargados;
  document.getElementById('totalNoCargados').innerText = totalNoCargados;
  list.forEach((s, idx) => {
    let bodegaHtml = '';
    if (s.estatus === "Cargado") {
      bodegaHtml = `<select onchange="updateSindBodega('${s.id}',this.value)" class="bodega-select">` +
        `<option value="1"${s.bodega == "1" ? " selected" : ""}>1</option>` +
        `<option value="2"${s.bodega == "2" ? " selected" : ""}>2</option>` +
        `<option value="3"${s.bodega == "3" ? " selected" : ""}>3</option>` +
        `<option value="4"${s.bodega == "4" ? " selected" : ""}>4</option>` +
        `<option value="5"${s.bodega == "5" ? " selected" : ""}>5</option>` +
        `<option value="6"${s.bodega == "6" ? " selected" : ""}>6</option>` +
        `</select>`;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${s.ficha}</td>
      <td>${s.no}</td>
      <td>${s.placa}</td>
      <td>${s.producto}</td>
      <td><select onchange="updateEstatusSindicato('${s.id}', this.value)">
        <option value="Cargado"${s.estatus == "Cargado" ? " selected" : ""}>Cargado</option>
        <option value="No Cargado"${s.estatus == "No Cargado" ? " selected" : ""}>No Cargado</option>
        </select>
      </td>
      <td>${bodegaHtml}</td>
      <td><button onclick="delSindicato(${s.id})">Eliminar</button></td>
    `;
